#cloud-config
# =============================================================================
# Coding Agent VM Configuration
# =============================================================================
# Cloud-init configuration for Multipass VM with Claude Code and Gemini CLI.
# Supports SSH Agent Forwarding for secure git commit signing.
# =============================================================================

package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - gnupg
  - git
  - jq
  - openssh-client
  - build-essential
  - trash-cli

# =============================================================================
# Install Node.js 22.x and Coding Agents
# =============================================================================

runcmd:
  # Install Node.js 22.x via NodeSource
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
  - echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main" > /etc/apt/sources.list.d/nodesource.list
  # Install GitHub CLI
  - curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
  - chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
  - apt-get update
  - apt-get install -y nodejs gh
  # Install Claude Code and Gemini CLI globally
  - npm install -g @anthropic-ai/claude-code @google/gemini-cli
  # Install mise (runtime manager)
  - |
    sudo -u ubuntu bash -c 'curl https://mise.run | sh'
  - |
    sudo -u ubuntu bash -c 'echo "export PATH=\"\$HOME/.local/bin:\$PATH\"" >> ~/.profile'
  - |
    sudo -u ubuntu bash -c 'echo "export PATH=\"\$HOME/.local/bin:\$PATH\"" >> ~/.bashrc'
  - |
    sudo -u ubuntu bash -c 'echo "eval \"\$(mise activate bash)\"" >> ~/.bashrc'
  - |
    sudo -u ubuntu bash -c 'echo "eval \"\$(mise activate bash)\"" >> ~/.profile'
  # Create .claude/skills directory for ubuntu user
  - sudo -u ubuntu mkdir -p /home/ubuntu/.claude/skills
  # Configure SSH for common Git hosting services
  - mkdir -p /etc/ssh/ssh_config.d
  - |
    cat > /etc/ssh/ssh_config.d/git-hosts.conf << 'EOF'
    Host github.com gitlab.com bitbucket.org
        StrictHostKeyChecking accept-new
        IdentitiesOnly yes
    EOF
  # Add github.com to known_hosts
  - sudo -u ubuntu mkdir -p /home/ubuntu/.ssh
  - sudo -u ubuntu chmod 700 /home/ubuntu/.ssh
  - ssh-keyscan github.com >> /home/ubuntu/.ssh/known_hosts
  - chown ubuntu:ubuntu /home/ubuntu/.ssh/known_hosts
  # Configure Git for SSH signing (system-wide)
  - git config --system gpg.format ssh
  - git config --system commit.gpgsign true
  - git config --system tag.gpgsign true
  # Print completion message
  - echo "Cloud-init completed. VM is ready for use."

# =============================================================================
# Final Message
# =============================================================================

final_message: |
  =============================================================================
  Coding Agent VM is ready!

  Use jig commands:
    jig ssh       # Interactive shell
    jig claude    # Run Claude Code
    jig gemini    # Run Gemini CLI
  =============================================================================
