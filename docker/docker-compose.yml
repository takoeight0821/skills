# Docker Compose for Linux
# Usage: docker compose up -d

services:
  coding-agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: coding-agent

    stdin_open: true
    tty: true

    user: agent
    working_dir: /workspace

    volumes:
      # Mount project directory
      - ../:/workspace:cached

      # SSH public keys only (read-only) - private keys stay on host
      - ${HOME}/.ssh/id_ed25519.pub:/home/agent/.ssh-host/id_ed25519.pub:ro
      - ${HOME}/.ssh/known_hosts:/home/agent/.ssh-host/known_hosts:ro

      # Persist agent configurations
      - agent-config:/home/agent/.config
      # Note: SSH agent forwarding is added in platform-specific override files

    environment:
      - TERM=xterm-256color
      - SSH_AUTH_SOCK=/tmp/ssh-agent.sock
      - GIT_USER_NAME=${GIT_USER_NAME:-}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-}
      - GIT_SIGNING_KEY=/home/agent/.ssh-host/id_ed25519.pub
      # API keys (load from environment or .env file)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW

volumes:
  agent-config:
